---
export const prerender = true;
import { render } from "astro:content";
import { getEntry } from "astro:content";
import { slugify } from "@lib/string";
import { getAllPosts, getSeriesPosts } from "@lib/content";

import { ArrowLeft } from "@lucide/astro";

import Heading from "@component/Heading.astro";
import BaseLayout from "@layout/BaseLayout.astro";
import SeriesTable from "@component/SeriesTable.astro";
import TableOfContent from "@component/TableOfContent";

import { MdxComponents } from "@component/MdxComponents.ts";

export function getStaticPaths() {
    const allPosts = getAllPosts();

    return Array.from(allPosts).map((post) => ({
        params: {
            slug: post.frontmatter.title.toLowerCase().replace(/ /g, "-"),
        },
    }));
}

const dateObject: object = {
    year: "numeric",
    month: "long",
    day: "numeric",
};

const { slug } = Astro.params;
const post = await getEntry("posts", slug);

if (!post.data.published) {
    return Astro.redirect("/404");
}

const { Content, headings } = await render(post);

const siteUrl = "https://www.bijonsetyawan.com";
const postUrl = `${siteUrl}/posts/${slug}`;

const blogPostingSchema = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: post.data.title,
    description: post.data.description,
    url: postUrl,
    datePublished: post.data.publishedDate?.toISOString(),
    author: {
        "@type": "Person",
        name: "Bijon Setyawan Raya",
        url: siteUrl,
    },
    publisher: {
        "@type": "Person",
        name: "Bijon Setyawan Raya",
        url: siteUrl,
    },
    keywords: post.data.keywords?.join(", "),
    articleSection: post.data.tag,
    inLanguage: "en-US",
    isPartOf: {
        "@type": "Blog",
        "@id": `${siteUrl}/posts`,
        name: "Bijon Setyawan Raya — Posts",
        url: `${siteUrl}/posts`,
    },
};
---

<BaseLayout
    hasMath={true}
    pageTitle={post.data.title}
    pageDescription={post.data.description}
    keywords={post.data.keywords ?? []}
    ogType="article"
    publishedDate={post.data.publishedDate}
    articleTag={post.data.tag}
    schema={blogPostingSchema}
>
    <a href="/posts" class="w-fit flex font-semibold hover:underline"
        ><ArrowLeft class="my-auto mr-1" />Back</a
    >
    <div class="flex gap-2 mt-5 mb-2 text-slate-700">
        {
            post.data.tag && (
                <a
                    class="underline cursor-pointer"
                    href={`/tag/${slugify(post.data.tag)}`}
                >
                    {post.data.tag}
                </a>
            )
        }
        <p>•</p>
        {
            post.data.publishedDate && (
                <div>
                    {new Date(post.data.publishedDate).toLocaleDateString(
                        "en-US",
                        dateObject,
                    )}
                </div>
            )
        }
    </div>
    <div class="mb-10">
        <Heading as="h1" weight="bold" class="lg:text-4xl text-3xl"
            >{post.data.title}</Heading
        >
        <p class="text-slate-600">{post.data.description}</p>
    </div>
    {
        post.data.series && (
            <SeriesTable
                series={post.data.series}
                posts={getSeriesPosts(post.data.series)}
                currentPost={post.data.title}
            />
        )
    }
    <Content components={MdxComponents} />
    {
        headings.length > 1 && (
            <TableOfContent
                url={`/posts/${slug}`}
                headings={headings}
                client:load
            />
        )
    }
</BaseLayout>
